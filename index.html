<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Examen - Modo Seguro (Demo)</title>
<style>
  :root{--accent:#1f77b4;--bg:#f7f9fc}
  body{font-family:Inter, Arial, sans-serif;background:var(--bg);margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh}
  header{background:var(--accent);color:#fff;padding:12px 18px}
  .container{max-width:900px;margin:18px auto;padding:18px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  h1{margin:0;font-size:20px}
  .meta{display:flex;justify-content:space-between;gap:12px;margin-top:8px;font-size:14px;color:#f0f7ff}
  #question {margin:16px 0}
  .options{display:flex;flex-direction:column;gap:8px}
  button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:6px;cursor:pointer}
  button.secondary{background:#e7eef9;color:#0b3a5a}
  .timer{font-weight:700;color:#d9534f}
  .small{font-size:13px;color:#666}
  .evidence{margin-top:12px}
  footer{margin-top:14px;text-align:center;color:#666;font-size:13px}
  .warning{background:#fff7e6;border-left:4px solid #ff9900;padding:10px;margin:12px 0;border-radius:6px}
  pre{white-space:pre-wrap;word-wrap:break-word;background:#f5f7fb;padding:10px;border-radius:6px}
</style>
</head>
<body>
<header>
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <h1>Examen — Razonamiento / Informática (Demo)</h1>
      <div class="meta">Tiempo total: <span id="totalTime">30</span> min • Intentos de cambiar pestaña: <span id="focusCount">0</span></div>
    </div>
    <div class="timer">Tiempo restante: <span id="timer">--:--</span></div>
  </div>
</header>

<main class="container" role="main">
  <div class="warning">
    <strong>Importante:</strong> durante el examen evite cambiar de pestaña o abrir otras aplicaciones. El sistema registra intentos de cambio de pestaña y puede invalidar la prueba.
  </div>

  <label>
    Tu nombre (obligatorio): <input id="studentName" type="text" style="padding:8px;margin-left:6px;width:60%" required>
  </label>

  <section id="examArea">
    <div id="intro" class="small">
      Presiona <strong>Comenzar examen</strong> cuando estés listo. El temporizador iniciará y el examen se bloqueará en pantalla.
    </div>

    <div id="question" aria-live="polite"></div>

    <div style="display:flex;gap:10px;align-items:center">
      <button id="prevBtn" class="secondary">Anterior</button>
      <button id="nextBtn">Siguiente</button>
      <div style="margin-left:auto" class="small">Pregunta <span id="qIndex">0</span> / <span id="qTotal">0</span></div>
    </div>

    <div class="evidence">
      <label class="small">Sube evidencia (foto de procedimiento a mano):</label><br>
      <input id="evidenceFile" type="file" accept="image/*,application/pdf">
    </div>

    <div style="margin-top:12px">
      <button id="submitBtn" style="background:#2ca02c">Enviar examen</button>
    </div>

    <div style="margin-top:12px" id="logArea" class="small"></div>

  </section>

  <section style="margin-top:14px">
    <h3 class="small">Registro (no editable por alumno)</h3>
    <pre id="logPre">-- eventos --</pre>
  </section>
</main>

<footer>
  <div class="small">Página para examen. Si detectamos 3 cambios de pestaña el examen podrá bloquearse o enviarse automáticamente.</div>
</footer>

<script>
/* =========================
   CONFIGURACIÓN RÁPIDA
   ========================= */
const TOTAL_MINUTES = 30;          // tiempo examen en minutos
const MAX_TAB_SWITCHES = 3;        // veces permitidas antes de marcar/suspender
const UPLOAD_ENDPOINT = "";        // si tienes backend, pon aquí la URL POST para recibir JSON y archivos

/* =========================
   BANCO DE PREGUNTAS (editable)
   - type: 'mcq' (opción única) o 'open' (abierta)
   - choices solo para mcq
   - correct para calificación local (opcional)
   ========================= */
const QUESTION_BANK = [
  {id:1, type:'mcq', q:"¿Cuántos centímetros hay en 4.5 metros?", choices:["450 cm","4500 cm","45 cm","0.45 cm"], correct:1},
  {id:2, type:'mcq', q:"¿Cuál es el área de un terreno rectangular de 12 m × 18 m?", choices:["96 m²","120 m²","216 m²","324 m²"], correct:2},
  {id:3, type:'open', q:"Una sala mide 4.2 m × 5.6 m. Se necesitan baldosas de 40 cm × 40 cm. ¿Cuántas baldosas se requieren? (Explique y entregue resultado numérico)"},
  {id:4, type:'open', q:"Un nutricionista hace caminatas de 3,750 metros. ¿Cuántos kilómetros son?"},
  {id:5, type:'mcq', q:"¿Cuál unidad es cuadrada?", choices:["km","m²","cm","g"], correct:1}
];

// ---- generar versión aleatoria por usuario ----
function shuffle(a){ for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
let questions = shuffle([...QUESTION_BANK]); // mezcla preguntas
questions.forEach(q=>{
  if(q.type==='mcq') q.choices = shuffle(q.choices.slice());
});
/* =========================
   UI y lógica
   ========================= */
const qArea = document.getElementById('question');
const qIndex = document.getElementById('qIndex');
const qTotal = document.getElementById('qTotal');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');
const logPre = document.getElementById('logPre');
const logArea = document.getElementById('logArea');
const timerSpan = document.getElementById('timer');
const totalTimeSpan = document.getElementById('totalTime');
const focusCountSpan = document.getElementById('focusCount');

totalTimeSpan.textContent = TOTAL_MINUTES;

let current = 0;
let answers = Array(questions.length).fill(null);
qTotal.textContent = questions.length;
qIndex.textContent = 0;

// render pregunta
function renderQuestion(i){
  const item = questions[i];
  qArea.innerHTML = "";
  const h = document.createElement('h2'); h.textContent = item.q; qArea.appendChild(h);
  if(item.type==='mcq'){
    const div = document.createElement('div'); div.className='options';
    item.choices.forEach((c,idx)=>{
      const id = `opt-${i}-${idx}`;
      const label = document.createElement('label');
      label.innerHTML = `<input type="radio" name="q${i}" value="${c}" id="${id}"> ${c}`;
      div.appendChild(label);
    });
    qArea.appendChild(div);
    // restore
    if(answers[i]) {
      const checks = document.getElementsByName('q'+i);
      for(let ch of checks) if(ch.value===answers[i]) ch.checked=true;
    }
  } else {
    const ta = document.createElement('textarea'); ta.style.width='100%'; ta.style.minHeight='120px'; ta.id='open-'+i;
    if(answers[i]) ta.value = answers[i];
    qArea.appendChild(ta);
  }
  qIndex.textContent = i+1;
}

// save current answer
function saveAnswer(i){
  const item = questions[i];
  if(item.type==='mcq'){
    const checks = document.getElementsByName('q'+i);
    for(let ch of checks) if(ch.checked) {answers[i]=ch.value; return;}
    answers[i]=null;
  } else {
    const ta = document.getElementById('open-'+i);
    answers[i] = ta ? ta.value.trim() : null;
  }
}

// navigation
prevBtn.addEventListener('click',()=>{
  saveAnswer(current);
  if(current>0) current--;
  renderQuestion(current);
});
nextBtn.addEventListener('click',()=>{
  saveAnswer(current);
  if(current<questions.length-1) current++;
  renderQuestion(current);
});

submitBtn.addEventListener('click',async ()=>{
  saveAnswer(current);
  // validate name
  const name = document.getElementById('studentName').value.trim();
  if(!name){ alert('Escribe tu nombre antes de enviar'); return; }
  // collect evidence file
  const fileInput = document.getElementById('evidenceFile');
  let fileInfo = null;
  if(fileInput.files.length>0){
    const f = fileInput.files[0];
    fileInfo = {name:f.name,size:f.size,type:f.type};
    // if you want to upload here, use FormData + fetch to UPLOAD_ENDPOINT
  }
  const payload = {
    name, startedAt, endedAt:Date.now(), durationMinutes:TOTAL_MINUTES,
    questions: questions.map((q,idx)=>({id:q.id, q:q.q, type:q.type, answer:answers[idx] || ""})),
    events: eventLog,
    file: fileInfo
  };
  // show payload summary
  document.getElementById('logArea').innerText = "Enviando examen... (demo no tiene backend). Revisa consola para payload.";
  console.log("PAYLOAD",payload);
  alert('Examen listo. En un entorno real se enviaría al servidor. (Demo)');

  // if you have endpoint, uncomment and set UPLOAD_ENDPOINT:
  /*
  const fd = new FormData();
  fd.append('payload', JSON.stringify(payload));
  if(fileInput.files.length>0) fd.append('evidence', fileInput.files[0]);
  const res = await fetch(UPLOAD_ENDPOINT, {method:'POST', body:fd});
  const json = await res.json();
  console.log(json);
  */
});

// initial render
renderQuestion(0);

/* =========================
   Temporizador
   ========================= */
let startedAt = Date.now();
let remaining = TOTAL_MINUTES*60;
function tick(){
  remaining--;
  if(remaining<0){
    timerSpan.textContent = "00:00";
    // auto submit
    alert('Tiempo terminado. El examen se enviará automáticamente.');
    submitBtn.click();
    clearInterval(timerInterval);
    return;
  }
  const mm = Math.floor(remaining/60).toString().padStart(2,'0');
  const ss = (remaining%60).toString().padStart(2,'0');
  timerSpan.textContent = mm+":"+ss;
}
const timerInterval = setInterval(tick,1000);
tick();

/* =========================
   Detección de visibilidad / enfoque (anti-tab switching)
   ========================= */
let focusCount = 0;
let eventLog = [];
function logEvent(msg){ const t = new Date().toISOString(); eventLog.push({t,msg}); logPre.textContent = JSON.stringify(eventLog,null,2); }
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){
    focusCount++;
    focusCountSpan.textContent = focusCount;
    logEvent('visibilitychange:hidden');
    if(focusCount >= MAX_TAB_SWITCHES){
      alert('Se detectaron múltiples cambios de pestaña. El examen será bloqueado y enviado.');
      saveAnswer(current);
      submitBtn.click();
    }
  } else {
    logEvent('visibilitychange:visible');
  }
});
window.addEventListener('blur', ()=>{ logEvent('window:blur');});
window.addEventListener('focus', ()=>{ logEvent('window:focus');});

/* =========================
   Bloqueo de teclas y menú contextual
   ========================= */
document.addEventListener('contextmenu', e=>{ e.preventDefault(); logEvent('contextmenu blocked');});
document.addEventListener('keydown', e=>{
  // block common dev/cheat keys
  if(e.key==='F12' || (e.ctrlKey && e.shiftKey && (e.key==='I' || e.key==='J')) || (e.ctrlKey && e.key==='U') || (e.ctrlKey && e.key==='T')){
    e.preventDefault(); logEvent('blocked key '+e.key);
    return false;
  }
  // optionally block copy
  // if(e.ctrlKey && e.key==='c'){ e.preventDefault(); logEvent('blocked copy'); return false;}
});

/* =========================
   Antesunload warning (evita cerrar sin submit)
   ========================= */
window.addEventListener('beforeunload', function (e) {
  // most browsers ignore custom message but will show default prompt
  e.preventDefault(); e.returnValue = '';
});

/* =========================
   Mensajería de logs inicial
   ========================= */
logEvent('exam_started');
logPre.textContent = JSON.stringify(eventLog,null,2);

</script>
</body>
</html>
